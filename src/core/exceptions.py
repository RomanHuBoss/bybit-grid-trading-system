"""
Иерархия исключений для алгоритмической системы AVI-5.

Модуль определяет общий базовый класс исключений и набор
доменных и инфраструктурных ошибок, которые от него наследуются.

Каждое исключение содержит:
    - человекочитаемое сообщение (message),
    - опциональный словарь details с дополнительным контекстом
      (для логирования, audit trail, алертинга и аналитики).
"""


class AlgoGridBaseException(Exception):
    """
    Базовый класс для всех бизнес- и инфраструктурных ошибок
    в системе AVI-5.

    Атрибуты:
        message: Строковое описание ошибки для человека.
        details: Необязательный словарь с дополнительным
                 структурированным контекстом
                 (идентификаторы, полезная нагрузка, окружение).
    """

    message: str
    details: dict[str, object]

    def __init__(self, message: str, *, details: dict[str, object] | None = None) -> None:
        super().__init__(message)
        self.message = message
        self.details = details or {}

    def __str__(self) -> str:
        return self.message


class InvalidCandleError(AlgoGridBaseException):
    """
    Ошибка валидации свечи (например, для DTO ConfirmedCandle).

    Выбрасывается, если нарушены базовые проверки:
        - цена закрытия вне диапазона [low, high],
        - неположительный объём,
        - флаг подтверждения отсутствует, когда требуется
          подтверждённая свеча и т.п.
    """
    pass


class SignalExpiredError(AlgoGridBaseException):
    """
    Сигнал считается протухшим/устаревшим.

    Используется, когда сигнал пришёл позже допустимого
    грайс-периода (например, ~5 секунд после закрытия бара)
    и не должен больше участвовать в открытии новых позиций.
    """
    pass


class RiskLimitExceeded(AlgoGridBaseException):
    """
    Превышены настроенные риск-лимиты.

    Примеры:
        - превышено допустимое количество одновременных позиций,
        - превышена экспозиция по конкретному активу,
        - превышена общая совокупная экспозиция системы.
    """
    pass


class OrderPlacementError(AlgoGridBaseException):
    """
    Ошибка при размещении ордера на бирже.

    Возможные причины:
        - недостаточная маржа,
        - некорректная цена или количество,
        - валидационные ошибки на стороне Bybit
          или другие отказы при приёме ордера.
    """
    pass


class RateLimitExceededError(AlgoGridBaseException):
    """
    Превышен лимит частоты запросов (rate limit).

    Может относиться:
        - к лимитам на стороне Bybit,
        - к локальным лимитам на уровне приложения или IP.
    """
    pass


class WebhookError(AlgoGridBaseException):
    """
    Ошибка при отправке вебхука.

    Примеры:
        - сетевые/транспортные ошибки,
        - неуспешный HTTP-статус,
        - ошибки формирования или подписи полезной нагрузки.
    """
    pass


class DatabaseError(AlgoGridBaseException):
    """
    Ошибка уровня базы данных.

    Варианты:
        - проблемы с подключением,
        - ошибки выполнения SQL-запросов,
        - нарушения ограничений целостности или консистентности данных.
    """
    pass


class ConfigLoadError(AlgoGridBaseException):
    """
    Ошибка загрузки или валидации конфигурации приложения.

    Причины:
        - отсутствует или повреждён файл конфигурации,
        - некорректные переменные окружения,
        - нарушения ограничений в моделях AppConfig/AVI5Config.
    """
    pass


class WSConnectionError(AlgoGridBaseException):
    """
    Ошибка установления или поддержания WebSocket-соединения.

    Примеры:
        - таймаут при подключении,
        - нештатное закрытие соединения,
        - протокольные или аутентификационные ошибки.
    """
    pass
