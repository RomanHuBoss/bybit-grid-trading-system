<!-- docs/runbooks/no_ws_data.md -->

# Runbook: Потеря WebSocket-данных (`no_ws_data`)

## 1. Контекст

Алерт `no_ws_data` означает, что система перестала получать рыночные данные (свечи/WS-поток) по одному или нескольким ключевым инструментам.  
Риск: стратегия «слепнет», решения принимаются на устаревших данных.

## 2. Как распознать проблему

1. Сработал алерт `no_ws_data` из `monitoring/alerts.yml`.
2. На Grafana-дашборде *Market Data / WS*:
   - метрика «последний kline timestamp» по одному/нескольким символам не обновляется;
   - `ws_messages_per_second` ≈ 0 для этих символов.
3. В логах `src/market_data/ws_client.py`:
   - частые reconnect’ы;
   - ошибки декодирования или timeouts.

## 3. Быстрый triage

1. Проверить, массовая ли проблема:
   - один символ или все;
   - только kline, или также orderbook / приватный поток.
2. Проверить сторону биржи:
   - статус страницу/каналы Bybit (prod/testnet);
   - наличие инцидента у провайдера.
3. Проверить инфраструктуру:
   - `/health` — компонент WS/market_data не в `down`;
   - нет ли проблем с DNS/файрволом/прокси.

## 4. Пошаговые действия

### 4.1. Если проблема локальная (WS-клиент, а не биржа)

1. **Перезапуск WS-клиента**:
   - в docker-compose: `docker compose restart market_data` (конкретное имя сервиса — по `docker compose ps`);
   - в Kubernetes: `kubectl rollout restart deployment/market-data -n <namespace>`.
2. Убедиться, что:
   - новый pod/container вышел в `READY`;
   - в логах нет бесконечных reconnect’ов или ошибок аутентификации.
3. Проверить метрики:
   - `ws_messages_per_second` > 0;
   - last-seen timestamp по kline начал смещаться вперёд.

### 4.2. Если проблема на стороне биржи

1. Зафиксировать время начала инцидента и затронутые символы.
2. При подтверждённом инциденте Bybit:
   - **не** пытаться агрессивно увеличивать частоту reconnect/подписок;
   - при необходимости снизить торговую активность (обсудить с владельцем стратегии).
3. Подготовиться к gap-recovery:
   - оценить временной разрыв данных (по kline/OB);
   - запланировать дозагрузку пропущенных свечей через REST/бэкфилл-утилиты (вне критического пути SignalEngine).

### 4.3. Gap-recovery (восстановление пропуска данных)

1. Когда WS-стрим восстановлен:
   - выгрузить недостающие kline за интервал gap’а (REST Bybit или отдельный data-pipeline);
   - записать их в TimescaleDB тем же форматом, что и онлайн-данные.
2. Убедиться, что:
   - непрерывность временного ряда по каждому символу восстановлена;
   - агрегаты/материализованные view обновились (если используются).

## 5. Проверка восстановления

1. Алерт `no_ws_data` погас (или ушёл в `resolved`).
2. На дашборде:
   - last-seen kline/OB timestamp отстаёт от `now()` не больше, чем на 1–2 интервала;
   - нет провалов в данных на участке инцидента.
3. `/health` — компонент market_data в `ok`.

## 6. Эскалация и пост-инцидент

- Если инцидент длится > 15 минут и/или затрагивает несколько символов:
  - уведомить владельца продукта и риск-менеджера;
  - оценить, не требуется ли временно отключить торговлю по затронутым инструментам.
- Оформить краткий post-mortem:
  - причина (биржа / наша инфраструктура / конфиг);
  - масштаб и длительность;
  - нужны ли изменения в алертах и WS-клиенте.
