<!-- docs/runbooks/kill_switch_triggered.md -->

# Runbook: Срабатывание kill-switch (`kill_switch_triggered`)

## 1. Контекст

Kill-switch — механизм мгновенной остановки торговли (не открываются новые позиции).  
Он может быть включён:
- вручную админом через `/admin/kill_switch`;
- автоматически подсистемой мониторинга при нарушении риск-метрик (MaxDD, Net Expectancy и пр.).

## 2. Как распознать проблему

1. Сработал алерт `kill_switch_active == 1` дольше N минут.
2. В UI/логах:
   - попытки открыть новую позицию приводят к отказу с явной пометкой kill-switch.
3. В логах `monitoring/alerts.py` — запись о причине автоактивации (если включен автоматически).

## 3. Пошаговые действия

### 3.1. Определить источник

1. Проверить аудиторный след (`audit_trail`):
   - была ли операция `kill_switch_engage` от конкретного пользователя.
2. Если включил человек:
   - выяснить мотив (какой инцидент он увидел);
   - убедиться, что инцидент действительно существует и обрабатывается.
3. Если включил мониторинг:
   - посмотреть метрики MaxDD, WR, PF, slippage;
   - сравнить с порогами в спецификации.

### 3.2. Обеспечить безопасность

1. Убедиться, что:
   - новые позиции не открываются;
   - текущие позиции продолжают корректно сопровождаться (SL/TP, закрытие).
2. При необходимости:
   - привести позиции к безопасному уровню вручную (сокращение/закрытие).

### 3.3. Решение о снятии kill-switch

1. Совместно с владельцем продукта и риск-менеджером:
   - оценить, устранена ли первопричина;
   - оценить, не превысили ли мы допустимые метрики риска.
2. Если решение — **снять** kill-switch:
   - выполнить `/admin/kill_switch` (выключение);
   - мониторить в течение ближайших X часов:
     - error-rate,
     - риск-метрики,
     - стабильность интеграции с биржей.

## 4. Проверка и пост-инцидент

- Убедиться, что состояние kill-switch вернулось к нулю (метрика, UI).
- Задокументировать:
  - кто включил/выключил;
  - причина;
  - какие изменения/улучшения нужны (алерты, риск-модель, лимиты).
