<!-- docs/runbooks/http_latency_degraded.md -->

# Runbook: Деградация HTTP latency (`http_latency_degraded`)

## 1. Контекст

Алерт `http_latency_degraded` означает устойчивый рост времени ответа HTTP-эндпоинтов по сравнению с целями из `docs/load_testing.md`.

## 2. Как распознать проблему

1. Алерт `http_latency_degraded`.
2. В Grafana:
   - рост P95/P99 `http_request_duration_seconds`;
   - возможный рост CPU/потребления памяти.
3. При этом error-rate может оставаться низким.

## 3. Пошаговые действия

1. Выяснить, какие endpoints деградируют:
   - по label’ам `route`/`handler` в метриках;
   - по логам долгих запросов (если есть).
2. Проверить зависимости:
   - latency БД (`db_query_latency`);
   - latency Redis;
   - latency Bybit.
3. Проверить нагрузку:
   - нет ли нагрузочных тестов/аномального трафика;
   - нет ли утечек/роста очередей.

## 4. Митигация

1. Если проблема в БД:
   - оптимизировать запросы;
   - добавить индексы;
   - разгрузить тяжёлые отчёты/аналитику.
2. Если проблема в внешних интеграциях:
   - вынести тяжёлые операции в фоновые задачи;
   - уменьшить количество синхронных запросов.
3. При необходимости:
   - временно ограничить частоту тяжёлых API-операций;
   - добавить кэширование.

## 5. Проверка восстановления

- latency вернулась к целевым значениям;
- алерт погас;
- нет всплеска 5xx (миграция проблемы в «жёсткие» ошибки).
