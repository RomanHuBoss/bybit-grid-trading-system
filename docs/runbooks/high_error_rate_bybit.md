<!-- docs/runbooks/high_error_rate_bybit.md -->

# Runbook: Высокий error-rate Bybit (`high_error_rate_bybit`)

## 1. Контекст

Алерт `high_error_rate_bybit` сигнализирует о росте доли ошибок (4xx/5xx, timeouts) при запросах к Bybit API.  
Риски: неисполненные или дублирующиеся ордера, рассинхрон позиций, активация kill-switch.

## 2. Как распознать проблему

1. Сработал алерт `high_error_rate_bybit` (warning/critical).
2. В Grafana:
   - рост `bybit_http_error_rate`;
   - рост `bybit_http_latency_p95/p99`.
3. В логах:
   - частые `RateLimitError`, `WSConnectionError`, 5xx от Bybit.

## 3. Быстрый triage

1. Разделить ошибки по типу:
   - 4xx (auth, permission, rate limit) vs 5xx (сервер биржи) vs network (timeouts).
2. Проверить статус Bybit (status page, каналы).
3. Проверить конфиг:
   - не поменялись ли ключи/права API;
   - нет ли аномального роста частоты запросов (новый релиз/фича).

## 4. Пошаговые действия

### 4.1. Если доминируют 4xx

1. Проверить:
   - валидность API-ключей (не отозваны ли);
   - наличие необходимых прав (trade/read-only).
2. В случае rate limit:
   - убедиться, что лимиты и backoff в `BybitRESTClient` соответствуют документации биржи;
   - при необходимости уменьшить параллелизм/частоту запросов.
3. Исправить конфигурацию:
   - обновить ключи/права;
   - задеплоить фикс.

### 4.2. Если доминируют 5xx или timeouts

1. Подтвердить, что проблема не в нашей сети:
   - проверить доступность других внешних ресурсов из этого же окружения;
   - проверить DNS/прокси.
2. При подтверждённой проблеме на стороне Bybit:
   - **не** устраивать «шквал» ретраев — убедиться, что backoff экспоненциальный;
   - рассмотреть временное снижение торговой активности или включение kill-switch (по согласованию).
3. Задокументировать интервал и классы ошибок.

## 5. Проверка восстановления

1. `bybit_http_error_rate` вернулся к baseline (близко к 0, кроме ожидаемых edge-кейсов).
2. Латентность запросов к Bybit в пределах целевых из `docs/load_testing.md`.
3. Нет всплеска `order_rejections` и неконтролируемых ретраев в логах.

## 6. Эскалация и пост-инцидент

- Если ошибка на стороне Bybit:
  - эскалировать через каналы поддержки биржи, при необходимости — на бизнес-сторону.
- Если ошибка на нашей стороне:
  - завести баг/тикет;
  - добавить/уточнить интеграционные тесты в части retries/rate-limits.
