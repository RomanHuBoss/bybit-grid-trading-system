<!-- docs/runbooks/high_http_5xx_rate.md -->

# Runbook: Высокая доля HTTP 5xx (`high_http_5xx_rate`)

## 1. Контекст

Алерт `high_http_5xx_rate` означает рост доли 5xx-ответов на публичных HTTP-эндпоинтах AVI-5.  
Риски: системная деградация сервиса для всех пользователей.

## 2. Как распознать проблему

1. Алерт `high_http_5xx_rate` (warning/critical).
2. В Grafana:
   - повышение `api_error_rate`;
   - возможный рост latency.
3. В логах:
   - повторяющиеся stacktrace’ы (один и тот же exception);
   - ошибки подключения к БД/Redis/Bybit.

## 3. Пошаговые действия

1. Идентифицировать источник:
   - какой endpoint даёт больше всего 5xx (по label’ам в метриках);
   - какие исключения преобладают.
2. Проверить зависимости:
   - `/health` для БД/Redis;
   - алерты Bybit/DB/Redis.
3. Если причина — внешний сервис (Bybit/БД/Redis):
   - следовать соответствующим runbook’ам (`high_error_rate_bybit`, `db_down`, `redis_down`).

## 4. Если причина внутри приложения

1. Найти релевантный exception в логах.
2. Если недавний релиз:
   - проверить diff;
   - при необходимости выполнить rollback.
3. При known-bug:
   - применить workaround (ограничить использование проблемного endpoint’а);
   - завести баг и план фикса.

## 5. Проверка восстановления

- `api_error_rate` вернулась к baseline;
- 5xx в логах исчезли;
- нагрузка/latency нормальные.
