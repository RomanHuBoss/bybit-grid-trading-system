<!-- docs/runbooks/db_replication_lag.md -->

# Runbook: Отставание реплики PostgreSQL (`db_replication_lag`)

## 1. Контекст

Алерт `db_replication_lag` сигнализирует, что реплика PostgreSQL отстаёт от мастера больше допустимого времени.  
Риски: неконсистентные чтения, невозможность быстрого failover.

## 2. Как распознать проблему

1. Сработал алерт `db_replication_lag` (warning/critical).
2. На дашборде БД:
   - метрика replication lag (в секундах/байтах) превышает пороги;
   - рост latency запросов к реплике.

## 3. Пошаговые действия

1. Определить тип репликации (streaming/managed-cluster) и архитектуру (1 master, N replicas).
2. Проверить реплику:
   - нет ли ошибок в логах репликации;
   - не исчерпан ли диск;
   - достаточно ли CPU/IOPS.
3. Проверить нагрузку на мастер:
   - нет ли долгих транзакций, удерживающих WAL;
   - нет ли тяжёлых запросов, которые мешают репликации.

## 4. Митигация

1. Если проблема в ресурсе реплики:
   - временно увеличить ресурсы (CPU/IOPS);
   - при необходимости перезапустить реплику.
2. Если проблема в мастере:
   - завершить/оптимизировать долгие запросы;
   - при необходимости временно ограничить write-нагрузку.
3. При устойчивом лаге:
   - **не** использовать реплику для актуальных чтений до восстановления;
   - пересмотреть стратегию failover (в `docs/disaster_recovery.md`).

## 5. Проверка восстановления

- replication lag вернулся к baseline (единицы секунд);
- алерт `db_replication_lag` погас;
- нет аномалий по latency запросов к реплике.
