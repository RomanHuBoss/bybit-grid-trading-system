<!-- docs/runbooks/redis_down.md -->

# Runbook: Недоступность Redis (`redis_down`)

## 1. Контекст

Алерт `redis_down` означает недоступность Redis, используемого для:

- кэшей,
- очередей,
- распределённых блокировок и rate limiting.

## 2. Как распознать проблему

1. `/health` сообщает `redis=down` или деградацию.
2. Алерт `redis_down` из `monitoring/alerts.yml`.
3. В логах — ошибки подключения к Redis (`RedisError`, timeouts).

## 3. Пошаговые действия

1. Проверить, жив ли инстанс Redis:
   - `systemctl status` / docker / managed-консоль;
   - наличие OOM/перезапусков.
2. Проверить ресурсы:
   - память (нет ли eviction по `maxmemory`);
   - CPU/сеть.
3. Если использует кластер/сентинел:
   - убедиться, что лидер выбран корректно;
   - нет split-brain.

## 4. Митигация

1. Если инстанс просто упал:
   - перезапустить Redis;
   - убедиться, что конфиг корректен (persistence, maxmemory policy).
2. Если требуется переключение на резервный:
   - обновить connect-строки в конфиге приложения;
   - перезапустить backend.
3. Проверить восстановление блокировок и очередей:
   - нет ли «зависших» операций, которые ожидали lock;
   - нет ли дублей операций после восстановления.

## 5. Проверка восстановления

- `/health` показывает `redis=ok`;
- latency и error-rate операций Redis в норме;
- новые запросы проходят без ошибок блокировок/кэшей.
