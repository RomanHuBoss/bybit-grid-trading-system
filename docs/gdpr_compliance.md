# GDPR и политика хранения персональных данных

Документ описывает, как система **Bybit Algo-Grid System / стратегия AVI-5** обрабатывает, хранит и удаляет персональные данные пользователей в контексте требований GDPR (в первую очередь требования R-13 из общей спецификации).

Цель документа — дать прозрачные и технически проверяемые правила хранения и удаления данных, чтобы:

- минимизировать объём хранимых персональных данных;
- обеспечить корректную реализацию Right to be forgotten через анонимизацию;
- согласовать сроки retention для разных типов данных;
- учесть влияние резервного копирования и аварийного восстановления.

Документ описывает только техническую сторону; выбор правовых оснований обработки (contract, legitimate interest и т.п.) и конкретных юридических формулировок остаётся на стороне владельца продукта и юристов.

---

## 1. Область действия

Под действие настоящей политики подпадают все компоненты AVI-5, которые:

- хранят или обрабатывают идентификаторы пользователей;
- логируют успешные/неуспешные попытки входа, изменения настроек;
- привязывают торговые результаты и риск-метрики к конкретной учётной записи;
- создают резервные копии базы данных и архивы исторических данных.

Среда выполнения — production-инстанс AVI-5. Тестовые/стейджинг-окружения должны использовать обезличенные или синтетические данные.

---

## 2. Категории персональных данных

### 2.1. Основные персональные данные

В системе явно считаются персональными:

- **email пользователя** — основной идентификатор для логина и коммуникации;
- **сетевые атрибуты**:
  - IP-адрес (если логируется),
  - user-agent (если логируется);
- **финансовые результаты**, однозначно привязанные к конкретной учётной записи:
  - PnL по позициям,
  - производные метрики стратегии (WR, PF, MaxDD и т.п.), если они считаются по одному аккаунту.

Технический идентификатор `user_id` (UUID) сам по себе является псевдонимным идентификатором, но при наличии таблицы `users` с email и связями с позициями/сигналами он позволяет однозначно идентифицировать субъекта данных и, следовательно, попадает под сферу действия GDPR.

### 2.2. Дополнительные данные

К дополнительным относим:

- токены активации/сброса пароля;
- технические токены доступа (JWT, refresh) и связанные с ними идентификаторы;
- секреты 2FA (TOTP), если они хранятся в контуре AVI-5.

Эти данные используются только для целей аутентификации и безопасности и не используются для аналитики или профилирования.

---

## 3. Общие принципы обработки

1. **Минимизация**  
   - В логах и технических событиях по возможности используется `user_id`, а не email.  
   - Хранение IP/user-agent включается только при необходимости (например, для защиты от злоупотреблений) и на ограниченный срок.

2. **Ограничение сроков хранения (retention)**  
   Для каждой сущности задаётся явный срок хранения в “горячем” контуре (основная БД, основные логи). Исторические архивы в S3 и резервные копии БД живут по отдельной политике (см. `docs/backup_strategy.md`).

3. **Анонимизация по Right to be forgotten**  
   Вместо жёсткого удаления строк из критичных таблиц (`audit_trail`, торговая история) используется анонимизация:
   - email заменяется псевдонимизованным значением;
   - прямые ссылки `user_id` на конкретного пользователя заменяются анонимным идентификатором.

4. **Разделение окружений**  
   Production-сервис не используется для загрузки исторических данных и бэктестов, чтобы не смешивать исследовательские данные с боевыми и не увеличивать объём персональных данных в проде.

---

## 4. Политика хранения по типам данных

### 4.1. Учётные записи пользователей (`users`)

**Состав данных (минимальный):**

- `user_id` (UUID);
- `email`;
- `password_hash` (хэш пароля, без хранения оригинала);
- параметры 2FA (если включено);
- служебные поля: `is_active`, `last_login_at`, токены активации/сброса и пр.

**Срок хранения:**

- базово запись в `users` хранится **пока учётная запись активна** и требуется для оказания сервиса;
- после деактивации аккаунта по запросу пользователя или по решению администратора запись может быть **анонимизирована** (см. раздел 5).

**Особенности:**

- Пароль хранится только в виде защищённого хэша (Argon2id/bcrypt); изменение или удаление учётной записи не требует “дешифрования” чего-либо.
- При анонимизации:
  - email заменяется на псевдонимное значение (например, `deleted+<uuid>@example.invalid`);
  - токены активации/сброса, секреты 2FA и другие чувствительные поля обнуляются или удаляются;
  - `is_active` устанавливается в `false`.

### 4.2. Аудит и безопасность (`audit_trail`)

**Назначение:** фиксация критичных действий: входы, смена пароля, изменение настроек, включение/отключение 2FA, операции с API-ключами и т.п.

**Срок хранения:**

- конкретный срок хранения задаётся конфигурацией и согласуется с юридическим департаментом и заказчиком;
- запись в `audit_trail` **не удаляется** при запросе Right to be forgotten; вместо этого:

  - `user_id` заменяется на анонимный идентификатор (например, `anon:<uuid>`),
  - из полезной нагрузки удаляются/маскируются поля, содержащие PII (например, email).

Таким образом, сохраняется техническая и финансовая целостность истории действий, но пропадает возможность связать запись с конкретным человеком.

### 4.3. Журнальные логи приложения

Системные логи FastAPI/фоновых воркеров пишутся в JSONL-формате с ротацией и ограниченным retention.

**Срок хранения (горячий контур):**

- базовое допущение: **7 дней** retention логов, после чего файлы автоматически удаляются или архивируются во внешнюю систему логирования.

**Правила логирования:**

- не логировать email, токены, секреты 2FA;
- для пользовательских событий использовать `user_id` либо обезличенный идентификатор;
- IP и user-agent логировать только там, где это необходимо для безопасности/разбора инцидентов, и в минимальном объёме.

Конкретная реализация логирования и ротации должна соответствовать этим принципам и допущению по сроку хранения.

### 4.4. Торговые данные: сигналы, позиции, клины

Торговые данные могут содержать привязку к пользователю и финансовые результаты, поэтому попадают под GDPR.

**Основные таблицы:**

- `signals` — сигналы стратегии;
- `positions` — открытые/закрытые позиции;
- `klines_*` — рыночные свечи и производные временные ряды.

**Сроки хранения в основной БД:**

- `signals` — **90 дней**;
- `positions` — **180 дней**;
- `klines_*` — **30 дней**.

По достижении этих сроков:

- записи архивируются и выгружаются в S3 (через `src/core/archiver.py`);
- из основной БД старые записи удаляются.

Архивные данные в S3 уже не используются для оперативной торговли, но могут использоваться для исследовательских задач при условии анонимизации персональных идентификаторов (удаление/замена прямых ссылок на конкретного пользователя).

### 4.5. Дополнительные технические таблицы и метрики

Любые дополнительные таблицы, в которых:

- явно хранится email;
- хранится IP/user-agent;
- имеется прямая связь с `user_id` и финансовыми результатами,

должны быть:

1. описаны в `docs/database_schema.md` с пометкой, что содержат персональные данные;
2. включены в соответствующую политику retention (через конфигурацию archiver-сервисов или SQL-policies);
3. учитывать правила анонимизации из раздела 5.

---

## 5. Реализация Right to be forgotten

### 5.1. Общий процесс

1. Пользователь подаёт запрос на удаление/анонимизацию данных (через UI или службу поддержки).
2. Запрос регистрируется операционной командой (ticket/`audit_trail`-событие).
3. Backend запускает процедуру анонимизации для указанного `user_id`.
4. Результат фиксируется в `audit_trail` и, при необходимости, в отдельном реестре таких запросов.

### 5.2. Шаги анонимизации

1. **Деактивация аккаунта**

   - поле `is_active` для пользователя переводится в `false`;
   - любые действующие sessions/JWT-токены инвалидируются (через blacklist или смену ключей).

2. **Анонимизация записи в `users`**

   - `email` заменяется на псевдонимизированное значение, не позволяющее восстановить исходный адрес;
   - секреты 2FA, токены активации/сброса и другие чувствительные поля удаляются или обнуляются;
   - дополнительные PII-поля (если есть: имя, компания и т.п.) очищаются.

3. **Анонимизация `audit_trail`**

   - во всех записях `audit_trail` для данного `user_id` он заменяется на анонимный идентификатор (например, `anon:<uuid>`), одинаковый для всех записей данного пользователя;
   - полезная нагрузка событий очищается от прямых PII (email, IP, user-agent — по решению юристов и заказчика).

4. **Торговые данные (сигналы, позиции)**

   - если записи `signals`/`positions` привязаны к `user_id`, связь переводится на тот же анонимный идентификатор;
   - при этом финансовые показатели (PnL, WR, PF и т.д.) могут сохраняться для статистики стратегии, но без связи с конкретным человеком.

5. **Логи и оперативные кеши**

   - технические логи, содержащие упоминания email/IP, автоматически “смываются” ротацией (retention 7 дней);
   - в оперативных кешах/кварках (Redis и т.п.) ключи, содержащие PII (если такие используются), должны быть удалены в рамках процедуры.

### 5.3. Поведение при новых событиях

После анонимизации:

- система не должна генерировать новые события, привязанные к старому `user_id`/email;
- если пользователю разрешено заново зарегистрироваться, он получает новый `user_id`, не связанный с предыдущим.

---

## 6. Влияние резервного копирования и DR

### 6.1. Резервные копии БД и WAL-архивы

Резервные копии БД и архивы WAL-журналов хранятся в соответствии со стратегией, описанной в `docs/backup_strategy.md`:

- полные бэкапы БД;
- WAL-архивирование;
- хранение локальных и S3-копий с ограниченным сроком.

Это означает, что персональные данные могут сохраняться в составе резервных копий до истечения их срока хранения в backup-стратегии.

### 6.2. Применение Right to be forgotten к бэкапам

Технически модифицировать уже созданные резервные копии не предполагается. Для целей GDPR используется следующая модель:

- **live-данные** (основная БД, оперативные хранилища) обрабатываются в соответствии с настоящей политикой (анонимизация, удаление после retention);
- **бэкапы** используются исключительно для аварийного восстановления и не участвуют в текущей обработке данных;
- при восстановлении из бэкапа:
  - операционная команда должна повторно применить накопленные запросы на Right to be forgotten к восстановленной БД;
  - до завершения повторной анонимизации восстановленная БД не должна использоваться в боевом контуре.

Таким образом, старая копия с персональными данными не возвращается в эксплуатацию “как есть”.

---

## 7. Мониторинг и контроль соблюдения политики

- В рамках мониторинга должны отслеживаться:
  - корректная работа задач архивации/retention;
  - наличие ошибок в процедурах анонимизации;
  - аномально большие объёмы логов/таблиц, содержащих персональные данные.
- Отклонения фиксируются алертами и обрабатываются по runbook-процедурам (см. `docs/disaster_recovery.md` и связанные runbooks).

---

## 8. Связанные документы и артефакты

- `docs/database_schema.md` — детальное описание схемы БД, включая таблицы с персональными данными.
- `docs/backup_strategy.md` — стратегия резервного копирования и сроки хранения бэкапов.
- `docs/disaster_recovery.md` — план аварийного восстановления, в том числе порядок восстановления БД.
- Спецификация требований:
  - R-08 — сроки хранения сигналов/позиций/клинов и архивация в S3;
  - R-13 — требования GDPR/Data privacy и Right to be forgotten.
