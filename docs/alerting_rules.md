# Каталог алертов — Bybit Algo-Grid / стратегия AVI-5

Документ описывает основные **техничеcкие** и **бизнес-алерты** системы
**Bybit Algo-Grid System / стратегия AVI-5**.

Цель документа:

- зафиксировать список ключевых алертов с единым форматом;
- связать алерты с метриками и порогами (см. также `docs/load_testing.md`);
- привязать алерты к операционным инструкциям (`docs/runbooks/*.md`);
- помочь разработчикам, SRE и операторам одинаково понимать смысл сигналов Alertmanager.

Фактические правила для Prometheus/Alertmanager описаны в `monitoring/alerts.yml`.
Настоящий документ — «каталог» и пояснение.

---

## 1. Общие принципы алертинга

1. **“Тихая система — плохой знак”**  
   Отсутствие алертов не должно означать отсутствие наблюдаемости.
   Базовый набор health-алертов всегда включён.

2. **Меньше, но важнее**  
   Предпочтение — небольшому количеству хорошо настроенных алертов с понятной семантикой и runbook’ом, а не «ковровой бомбардировке».

3. **Runbook-driven**  
   На каждый алерт уровня `warning`/`critical` должна существовать операционная инструкция в `docs/runbooks/*.md`:
   - что означает алерт;
   - как диагностировать причину;
   - какие действия предпринять;
   - когда эскалировать.

4. **Связь с метриками и нагрузочным тестированием**  
   Пороговые значения для алертов должны быть согласованы с:
   - целевыми латентностями и error-rate из `docs/load_testing.md`;
   - требованиями R-14 по наблюдаемости и бизнес-метрикам.  

5. **Разделение по средам**  
   - В `staging` разрешено более агрессивное алертирование для тестов.
   - В `prod` часть noisy-алертов может быть «смягчена» (больше окна, выше пороги).

---

## 2. Классификация и формат алерта

Каждый алерт описывается набором полей:

- **ID** — логическое имя алерта (совпадает с `alert:` в `monitoring/alerts.yml`, если применимо);
- **Категория**:
  - `tech` — инфраструктура, БД, Redis, HTTP, WS;
  - `business` — торговая логика, метрики стратегии, kill-switch;
- **Серьёзность**: `info`, `warning`, `critical`;
- **Описание** — в одно-две строки «по-человечески»;
- **Метрика/источник** — какие метрики/логи используются;
- **Условия срабатывания** — словами; конкретные PromQL-выражения живут в `monitoring/alerts.yml`;
- **Runbook** — ссылка на `docs/runbooks/*.md`.

---

## 3. Каталог алертов

### 3.1. Потеря рыночных данных (WebSocket / свечи)

#### AL-01: `no_ws_data`

- **Категория:** `tech`
- **Серьёзность:** `critical`
- **Описание:**  
  На протяжении заданного интервала не приходят новые свечи/рыночные данные по ключевым символам. Стратегия потенциально «ослепла».
- **Метрики/источники:**  
  - счётчик/гейдж last-seen timestamp по WS-стриму (например, `ws_kline_last_timestamp_seconds`);
  - глубина очереди/lag обработки WebSocket-сообщений.
- **Условия срабатывания (идея):**
  - по каждому whitelisted-символу:
    - `now - last_kline_timestamp > N минут` (значение N согласуется с бизнес-командой, обычно 2–5 интервалов свечи);
  - либо `ws_messages_per_second` → 0 при живой бирже.
- **Ожидаемое действие:**  
  Проверить подключение к Bybit WS, наличие инцидента на стороне биржи, переключение на fallback (REST) при необходимости.
- **Runbook:**  
  `docs/runbooks/no_ws_data.md`

---

### 3.2. Ошибки интеграции с Bybit

#### AL-02: `high_error_rate_bybit`

- **Категория:** `tech`
- **Серьёзность:** `warning` / `critical` (два уровня)
- **Описание:**  
  На интервале M минут наблюдается аномальный рост 4xx/5xx ответов от Bybit API.
- **Метрики/источники:**  
  - `bybit_http_requests_total{status}` и производные;
  - метрика error-rate Bybit интеграции (см. раздел 8.4 спецификации).
- **Условия срабатывания (идея):**
  - `warning`:
    - error-rate > 2% в течение 5 минут;
  - `critical`:
    - error-rate > 5% в течение 5 минут
    - и/или доля `5xx` выше заданного порога.
- **Ожидаемое действие:**  
  Проверить статус Bybit, корректность ключей/лимитов, посмотреть, не «штормят» ли ретраи, оценить необходимость временного ограничения торговли.
- **Runbook:**  
  `docs/runbooks/high_error_rate_bybit.md`

---

#### AL-03: `bybit_latency_degraded`

- **Категория:** `tech`
- **Серьёзность:** `warning`
- **Описание:**  
  Latency запросов к Bybit устойчиво выше целевых значений.
- **Метрики/источники:**  
  - `bybit_http_latency_p95/p99`, как в `docs/load_testing.md`.
- **Условия срабатывания (идея):**
  - `bybit_http_latency_p95` превышает целевой порог (например, 1–1.5 с) в течение 10 минут.
- **Ожидаемое действие:**  
  Анализ состояния внешнего API, возможное снижение торговой активности, проверка конфигурации ретраев и таймаутов.
- **Runbook:**  
  `docs/runbooks/bybit_latency_degraded.md`

---

### 3.3. Kill-switch и управление торговлей

#### AL-04: `kill_switch_triggered`

- **Категория:** `business`
- **Серьёзность:** `critical`
- **Описание:**  
  Включён глобальный kill-switch AVI-5: стратегия прекращает открывать новые позиции.
- **Метрики/источники:**  
  - гейдж `kill_switch_active` (Prometheus);
  - лог событий включения/выключения kill-switch.
- **Условия срабатывания (идея):**
  - `kill_switch_active == 1` более чем N минут (например, >5 минут).
- **Ожидаемое действие:**  
  - Проверить, кто и по какой причине включил kill-switch;
  - убедиться, что инцидент, ради которого он был включён, действительно обрабатывается;
  - по завершении — согласовать безопасное отключение.
- **Runbook:**  
  `docs/runbooks/kill_switch_triggered.md`

---

### 3.4. База данных и репликация

#### AL-05: `db_down`

- **Категория:** `tech`
- **Серьёзность:** `critical`
- **Описание:**  
  Основной инстанс PostgreSQL недоступен для приложений.
- **Метрики/источники:**  
  - `db_up` / health-пробы `/health` компонента `db`;
  - error-rate SQL-запросов и время ответа.
- **Условия срабатывания (идея):**
  - `db_up == 0` или часть health-проб `/health` возвращает `status: db=down` в течение K секунд.
- **Ожидаемое действие:**  
  Выполнить DR-процедуры в соответствии с `docs/disaster_recovery.md` (переключение на реплику, восстановление из backup при необходимости).
- **Runbook:**  
  `docs/runbooks/db_down.md`

---

#### AL-06: `db_replication_lag` (на будущее)

- **Категория:** `tech`
- **Серьёзность:** `warning` / `critical` (два уровня)
- **Описание:**  
  Отставание реплики PostgreSQL от мастера превышает допустимый порог.
- **Метрики/источники:**  
  - стандартные метрики Postgres по replication lag (например, в секундах).
- **Условия срабатывания (идея):**
  - `warning`: lag > 30 секунд;
  - `critical`: lag > 120 секунд.
- **Ожидаемое действие:**  
  Диагностика причины (IO/CPU/сеть), при необходимости — временное ограничение write-нагрузки, переключение схему чтения на мастер.
- **Runbook:**  
  `docs/runbooks/db_replication_lag.md`

---

### 3.5. Redis и распределённые блокировки

#### AL-07: `redis_down`

- **Категория:** `tech`
- **Серьёзность:** `critical`
- **Описание:**  
  Redis недоступен, что ставит под угрозу distributed-lock, rate limiting и очереди.
- **Метрики/источники:**  
  - `redis_up` / health-пробы компонента `redis`;
  - latency и error-rate Redis-операций.
- **Условия срабатывания (идея):**
  - `redis_up == 0` в течение K секунд.
- **Ожидаемое действие:**  
  Переключение на резервный инстанс Redis (если предусмотрено), восстановление блокировок, проверка стабильности работы rate-лимитеров.
- **Runbook:**  
  `docs/runbooks/redis_down.md`

---

### 3.6. HTTP API и общая доступность

#### AL-08: `high_http_5xx_rate`

- **Категория:** `tech`
- **Серьёзность:** `warning` / `critical`
- **Описание:**  
  Рост доли 5xx ответов на публичных HTTP-эндпоинтах AVI-5.
- **Метрики/источники:**  
  - HTTP-метрики FastAPI: счётчики запросов по статус-кодам.
- **Условия срабатывания (идея):**
  - `warning`: доля 5xx > 1% за последние 5 минут;
  - `critical`: доля 5xx > 5% за последние 5 минут.
- **Ожидаемое действие:**  
  Проверка логов, health зависимостей (БД, Redis, Bybit), оценка масштаба влияния на пользователей.
- **Runbook:**  
  `docs/runbooks/high_http_5xx_rate.md`

---

#### AL-09: `http_latency_degraded`

- **Категория:** `tech`
- **Серьёзность:** `warning`
- **Описание:**  
  HTTP latency FastAPI устойчиво выше проектных значений.
- **Метрики/источники:**  
  - `http_request_duration_seconds_p95/p99` по ключевым эндпоинтам.
- **Условия срабатывания (идея):**
  - P95 latency превышает целевые пороги, определённые в `docs/load_testing.md`, на протяжении N минут.
- **Ожидаемое действие:**  
  Анализ нагрузки, профилирование, проверка БД/Redis, оптимизация тяжёлых эндпоинтов.
- **Runbook:**  
  `docs/runbooks/http_latency_degraded.md`

---

### 3.7. Производительность стратегии и бизнес-метрики

#### AL-10: `wr_drop`

- **Категория:** `business`
- **Серьёзность:** `warning`
- **Описание:**  
  Падение win-rate (WR) стратегии ниже ожидаемого диапазона.
- **Метрики/источники:**  
  - бизнес-метрика `strategy_wr` в Prometheus.
- **Условия срабатывания (идея):**
  - WR за rolling-окно (например, 30 дней или N сделок) падает ниже предопределённого порога/границ доверительного интервала.
- **Ожидаемое действие:**  
  Анализ рыночного режима, калибровка параметров AVI-5, возможно — временное снижение объёма торгов.
- **Runbook:**  
  `docs/runbooks/wr_drop.md`

---

#### AL-11: `slippage_spike`

- **Категория:** `business`
- **Серьёзность:** `warning`
- **Описание:**  
  Существенный рост проскальзывания по сделкам относительно исторических значений.
- **Метрики/источники:**  
  - метрики по slippage (например, средний/максимальный slippage по символам за интервал).
- **Условия срабатывания (идея):**
  - средний slippage на горизонте H минут в X раз больше медианы/исторической нормы.
- **Ожидаемое действие:**  
  Проверка ликвидности, параметров ордеров (тип, цена, время жизни), при необходимости — снижение размера позиций.
- **Runbook:**  
  `docs/runbooks/slippage_spike.md`

---

#### AL-12: `max_drawdown_exceeded`

- **Категория:** `business`
- **Серьёзность:** `critical`
- **Описание:**  
  Достигнут или превышен допустимый уровень просадки (MaxDD) по счёту/стратегии.
- **Метрики/источники:**  
  - бизнес-метрика `strategy_max_drawdown`.
- **Условия срабатывания (идея):**
  - текущая просадка ≥ лимита, согласованного с владельцем продукта/риск-менеджментом.
- **Ожидаемое действие:**  
  Рассмотреть остановку торговли (или включение kill-switch), инициировать детальный разбор причин, уведомить заинтересованные стороны.
- **Runbook:**  
  `docs/runbooks/max_drawdown_exceeded.md`

---

## 4. Поддержка и эволюция алертинга

- Любое добавление новых метрик или изменение ключевой логики (WS, Bybit, риск, DR) должно сопровождаться:
  - ревизией существующих алертов;
  - добавлением новых алертов при необходимости;
  - обновлением runbook’ов.
- Любой алерт уровня `critical`, на который команда **не знает, как реагировать**, должен быть либо:
  - убран/понижен до `warning`,
  - либо снабжён понятным runbook’ом и эскалацией.

---

## 5. Связанные документы и файлы

- `monitoring/alerts.yml` — фактические определения Prometheus/Alertmanager-правил.
- `docs/runbooks/*.md` — пошаговые инструкции по реагированию на инциденты.
- `docs/load_testing.md` — целевые значения latency, error-rate и др., которые используются для настройки порогов.
- `docs/test_plan.md` — общая стратегия тестирования, включая проверку метрик и алертов.
- `docs/disaster_recovery.md` — сценарии DR, на которые завязаны алерты уровня `db_down`, `db_replication_lag`, `redis_down` и близкие.
